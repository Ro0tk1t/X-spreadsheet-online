<!--
 * @Author: your name
 * @Date: 2020-11-10 22:12:08
 * @LastEditTime: 2020-12-13 20:42:13
 * @LastEditors: Please set LastEditors
 * @Description: In User Settings Edit
 * @FilePath: /xspreadsheet/index.html
-->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title><%= htmlWebpackPlugin.options.title %></title>
</head>
<body onload="load()">
  <div id="x-spreadsheet-demo"></div>
  <script>
    function load() {
        //package.json 中 可以修改 dev 命令 webpack-dev-server 为自动编译 webpack 为手动编译
        var xs = x_spreadsheet('#x-spreadsheet-demo', {showToolbar: true, showGrid: true});
        var ws = new WebSocket("ws://localhost:8088/ws");
        window.xs = xs;
        expand();

        // 在 expand 中进行了 window.xs.currentfield 字段的部分初始化，这里为了模拟跳转后的状态，再写入一些静态数据作为测试时展示
        window.xs.currentField.source = {};
        window.xs.currentField.source.type = "postgresql"; //数据源类型，如果是api数据则为"api"
        window.xs.currentField.source.host = "http://106.75.227.222"; //ip地址，如果是数据源则为api地址
        window.xs.currentField.source.port = "5432"; //端口号，如果为api，则为空
        window.xs.currentField.source.username = "postgres"; //用户名，如果为api，则为空
        window.xs.currentField.source.password = "123456"; //密码，如果为api，则为空
        window.xs.currentField.source.dbname = "postgres"; //库名，如果为api，则为空
        window.xs.currentField.source.tablename = "employee"; //表名，如果为api，则为空

        // 作者和表格名字也是传来的参数
        window.xs.currentField.detail = {};
        window.xs.currentField.detail.author = "JH";
        window.xs.currentField.detail.filename = "ceshi";

           //连接打开时触发 
      ws.onopen = function(evt) {  
        console.log("Connection open ...");  
      };  
      //接收到消息时触发  
      ws.onmessage = function(evt) {  
        console.log("触发获取远程数据事件");  
        let obj = JSON.parse(evt.data)
      
        xs.cellText(obj.ri,obj.ci,obj.text)
        //console.log(xs.datas[0])
        xs.datas[0].styles = obj.styles
        //console.log(xs.datas[0].rows._[obj.ri].cells[obj.ci])
        console.log('merge info')
        xs.datas[0].rows._[obj.ri].cells[obj.ci].text = obj.text
        if (obj.style != undefined) {
          xs.datas[0].rows._[obj.ri].cells[obj.ci]['style'] = obj.styleID
        }
        if (obj.merges.length > 0) {
          console.log(obj.merges)
          for (var k =0 ;k<obj.merges.length;++k) {
          var tmp = obj.merges[k];
          window.xs.addMergeCell(0,tmp.sri,tmp.sci,tmp.eri,tmp.eci)
          }
        }
        xs.reRender()
      };  

      //连接关闭时触发  
      ws.onclose = function(evt) {  
        console.log("Connection closed.");  
      }; 
   
      xs.on('cell-selected', (cell, ri, ci) => {
           
        }).on('cell-edited', (text, ri, ci) => {
          let change = xs.cell(ri,ci)
          // 现在只是实现了单个数据的上传，还需要考虑多个数据同时上传面对的大并发
          const changes = {
            "ri":ri,
            "ci":ci,
            "text":change.text,
            "styleID":xs.data.rows._[ri].cells[ci]['style'],
            "style":xs.cellStyle(ri,ci),
            "rows":xs.data.rows,
            "styles" : xs.data.styles,
            "merges": xs.datas[0].merges._
          }
          // 发送对象数据包，每次修改的 text值和style
          console.log("请求更改的数据")
          console.log(changes)
          ws.send(JSON.stringify(changes))
        });

      setTimeout(() => {
      }, 5000);
    }
  </script>
  <!--script type="text/javascript" src="https://unpkg.com/x-data-spreadsheet@1.0.20/dist/locale/zh-cn.js"></script-->
</body>
</html>
